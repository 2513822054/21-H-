#include "Zfir.h"
#include <stdlib.h>
/*
 * FIR滤波，经过测算，32K采样频率的情况下最高阶数可以达到368阶
 *
 */

/*
 * 此处填fir滤波的系数信息
 */

const int ORDER = 334;
const float PARAMETER[334] = {
   0.007887986489,-0.001789513626,  -0.0016302109,-0.001500264159,-0.001383700874,
  -0.001271376037,-0.001152918092,-0.001027900958,-0.0008958539111,-0.0007659164839,
  -0.0006437929696,-0.0005409134901,-0.0004598910455,-0.0004056569887,-0.0003710060264,
  -0.0003515185672,-0.0003317224036,-0.0003049517982,-0.0002569201461,-0.0001909288403,
  -0.0001018145776,-1.293466994e-05, 7.67288293e-05,0.0001303211466,0.0001341526804,
  9.580986807e-05,-1.130140663e-05,-0.0001664996962,-0.0003482178727,-0.0005178332212,
  -0.0006439875579,-0.0006907391362,-0.0006364167202,-0.0004684769665,-0.0001984992996,
  0.0001450467098, 0.000511272985,0.0008410938899, 0.001070117229, 0.001146125607,
   0.001034477144,0.0007315833354,0.0002645528584,-0.000305327645,-0.0008959589759,
  -0.001404913724,-0.001745435293,-0.001833060756, -0.00163205585,-0.001146024792,
  -0.0004251712526,0.0004354650446, 0.001305340091, 0.002042780397, 0.002514891094,
   0.002622576896, 0.002316013677, 0.001610591426,0.0005869898596,-0.0006133264978,
  -0.001810241723,-0.002808918478,-0.003434040584,-0.003556312295,-0.003121030517,
  -0.002156984061,-0.0007842037594,0.0008074379293, 0.002376053715, 0.003669466823,
   0.004465074278,  0.00460164668, 0.004018343054, 0.002764643868,0.0009996367153,
  -0.001026417711,-0.003005911596,-0.004621824715,-0.005598063115,-0.005745749921,
  -0.004997354932,-0.003424321301,-0.001232758397, 0.001262070844, 0.003681144211,
   0.005639394745, 0.006806327496, 0.006961355451, 0.006033873651,   0.0041202344,
   0.001478964929,-0.001508446876,-0.004385801498,-0.006698048208,-0.008059429005,
   -0.00821756199,-0.007100508548,-0.004834274296,-0.001729332958,  0.00176021771,
   0.005102877505, 0.007770760451, 0.009323752485, 0.009480940178, 0.008170631714,
     0.0055481093, 0.001979354303,-0.002009777818,-0.005810685456,-0.008826408535,
   -0.01056355797, -0.01071523968,-0.009211445227,-0.006239565089,-0.002221062547,
   0.002248972654,  0.00648748409, 0.009831529111,  0.01173977274,  0.01188074704,
    0.01019013114,  0.00688727852, 0.002446519444,-0.002470137784,-0.007111981977,
   -0.01075461507, -0.01281407103, -0.01293993182, -0.01107495371,-0.007469254546,
  -0.002647270216, 0.002668020083, 0.007664548699,  0.01156603172,  0.01375206374,
    0.01385899726,  0.01183710527, 0.007967013866,  0.00281794928,-0.002834525891,
  -0.008126367815, -0.01223825756, -0.01452280954, -0.01460624207, -0.01245073136,
  -0.008363340981,-0.002952370327, 0.002963989042,  0.00848103594,  0.01274759043,
    0.01509766467,  0.01515509468,  0.01289375592, 0.008644512855, 0.003045541933,
  -0.003051816486,-0.008715871722,  -0.0130754374, -0.01545650419, -0.01548601594,
   -0.01315017417,-0.008799342439,-0.003093889914, 0.003095766995, 0.008822969161,
     0.0132109141,  0.01558717526,  0.01558717526,   0.0132109141, 0.008822969161,
   0.003095766995,-0.003093889914,-0.008799342439, -0.01315017417, -0.01548601594,
   -0.01545650419,  -0.0130754374,-0.008715871722,-0.003051816486, 0.003045541933,
   0.008644512855,  0.01289375592,  0.01515509468,  0.01509766467,  0.01274759043,
    0.00848103594, 0.002963989042,-0.002952370327,-0.008363340981, -0.01245073136,
   -0.01460624207, -0.01452280954, -0.01223825756,-0.008126367815,-0.002834525891,
    0.00281794928, 0.007967013866,  0.01183710527,  0.01385899726,  0.01375206374,
    0.01156603172, 0.007664548699, 0.002668020083,-0.002647270216,-0.007469254546,
   -0.01107495371, -0.01293993182, -0.01281407103, -0.01075461507,-0.007111981977,
  -0.002470137784, 0.002446519444,  0.00688727852,  0.01019013114,  0.01188074704,
    0.01173977274, 0.009831529111,  0.00648748409, 0.002248972654,-0.002221062547,
  -0.006239565089,-0.009211445227, -0.01071523968, -0.01056355797,-0.008826408535,
  -0.005810685456,-0.002009777818, 0.001979354303,   0.0055481093, 0.008170631714,
   0.009480940178, 0.009323752485, 0.007770760451, 0.005102877505,  0.00176021771,
  -0.001729332958,-0.004834274296,-0.007100508548, -0.00821756199,-0.008059429005,
  -0.006698048208,-0.004385801498,-0.001508446876, 0.001478964929,   0.0041202344,
   0.006033873651, 0.006961355451, 0.006806327496, 0.005639394745, 0.003681144211,
   0.001262070844,-0.001232758397,-0.003424321301,-0.004997354932,-0.005745749921,
  -0.005598063115,-0.004621824715,-0.003005911596,-0.001026417711,0.0009996367153,
   0.002764643868, 0.004018343054,  0.00460164668, 0.004465074278, 0.003669466823,
   0.002376053715,0.0008074379293,-0.0007842037594,-0.002156984061,-0.003121030517,
  -0.003556312295,-0.003434040584,-0.002808918478,-0.001810241723,-0.0006133264978,
  0.0005869898596, 0.001610591426, 0.002316013677, 0.002622576896, 0.002514891094,
   0.002042780397, 0.001305340091,0.0004354650446,-0.0004251712526,-0.001146024792,
   -0.00163205585,-0.001833060756,-0.001745435293,-0.001404913724,-0.0008959589759,
  -0.000305327645,0.0002645528584,0.0007315833354, 0.001034477144, 0.001146125607,
   0.001070117229,0.0008410938899, 0.000511272985,0.0001450467098,-0.0001984992996,
  -0.0004684769665,-0.0006364167202,-0.0006907391362,-0.0006439875579,-0.0005178332212,
  -0.0003482178727,-0.0001664996962,-1.130140663e-05,9.580986807e-05,0.0001341526804,
  0.0001303211466, 7.67288293e-05,-1.293466994e-05,-0.0001018145776,-0.0001909288403,
  -0.0002569201461,-0.0003049517982,-0.0003317224036,-0.0003515185672,-0.0003710060264,
  -0.0004056569887,-0.0004598910455,-0.0005409134901,-0.0006437929696,-0.0007659164839,
  -0.0008958539111,-0.001027900958,-0.001152918092,-0.001271376037,-0.001383700874,
  -0.001500264159,  -0.0016302109,-0.001789513626, 0.007887986489
};


/*
 * firInput 输入信号
 * firOutput 输出信号
 * blockSize 块大小
 * len 数据总长
 * */
void Fir_Do(float *firInput,float* firOutput,uint32_t blockSize,uint32_t len)
{
	uint32_t timeTick = HAL_GetTick();		//函数进入时间戳
	uint32_t timePass = 0;					//计算用时
	uint32_t numOfBlock = len / blockSize;	//
	uint32_t i;
	arm_fir_instance_f32 S;
	float32_t *pState;

	pState = (float32_t *)malloc((blockSize + ORDER - 1) * sizeof(float32_t));

	if(pState != NULL)
	{
		arm_fir_init_f32(&S,ORDER,(float32_t *)PARAMETER,pState,blockSize);
		for(i=0; i < numOfBlock; i++)
		{
			arm_fir_f32(&S, firInput + (i * blockSize), firOutput + (i * blockSize), blockSize);
		}
	}
	free(pState);
	/*
	 * 测试用
	timePass = HAL_GetTick() - timeTick;
	OutputAll(firInput, firOutput, testdata, firOutput, 320);
	*/
}



//实时滤波结构体
arm_fir_instance_f32  fir_realtime_S;
//实时滤波器开辟的暂存地址
float fir_realtime_P[999];
//实时fir滤波函数
void Fir_Realtime_Init()
{

	arm_fir_init_f32(&fir_realtime_S,ORDER,(float32_t *)PARAMETER,fir_realtime_P,1);
}
/*
 *
 * **/
void Fir_Realtime(float *firInput,float* firOutput)
{

	arm_fir_f32(&fir_realtime_S, firInput, firOutput, 1);
}




